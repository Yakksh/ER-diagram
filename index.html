<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ER Diagram</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: #e2e8f0;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1800px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .header h1 {
      font-size: 2.5rem;
      color: #fff;
      margin-bottom: 10px;
    }

    .header p {
      color: #94a3b8;
      font-size: 1.1rem;
    }

    .diagram-wrapper {
      position: relative;
      background: rgba(15, 23, 42, 0.5);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 40px;
      min-height: 1400px;
    }

    svg.connections {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }

    .entity {
      position: absolute;
      width: 280px;
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      border: 2px solid rgba(96, 165, 250, 0.3);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      transition: all 0.3s ease;
      z-index: 2;
      cursor: pointer;
    }

    .entity:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 48px rgba(59, 130, 246, 0.3);
      border-color: rgba(96, 165, 250, 0.6);
    }

    .entity-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .entity-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .entity-title {
      flex: 1;
    }

    .entity-name {
      font-size: 0.95rem;
      font-weight: bold;
      color: #fff;
      margin-bottom: 2px;
    }

    .entity-type {
      font-size: 0.75rem;
      color: #94a3b8;
    }

    .entity-fields {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 10px;
      font-family: 'Courier New', monospace;
      font-size: 0.75rem;
      color: #93c5fd;
    }

    .entity-field {
      margin-bottom: 4px;
    }

    .entity-field:last-child {
      margin-bottom: 0;
    }

    .entity-reason {
      font-size: 0.8rem;
      color: #cbd5e1;
      line-height: 1.4;
    }

    .connection-line {
      stroke: #3b82f6;
      stroke-width: 2;
      fill: none;
      opacity: 0.4;
      transition: opacity 0.3s ease;
    }

    .connection-line:hover {
      opacity: 0.8;
      stroke-width: 3;
    }

    .connection-label {
      fill: #60a5fa;
      font-size: 11px;
      font-weight: bold;
      text-anchor: middle;
    }

    .legend {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(96, 165, 250, 0.3);
      border-radius: 8px;
      padding: 15px;
      z-index: 10;
    }

    .legend-title {
      font-weight: bold;
      color: #fff;
      margin-bottom: 10px;
      font-size: 0.9rem;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 0.8rem;
      color: #cbd5e1;
    }

    .legend-line {
      width: 30px;
      height: 2px;
      background: #3b82f6;
    }

    /* Color variations for different entity types */
    .entity-org .entity-icon { background: linear-gradient(135deg, #3b82f6, #2563eb); }
    .entity-user .entity-icon { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
    .entity-integration .entity-icon { background: linear-gradient(135deg, #10b981, #059669); }
    .entity-resource .entity-icon { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .entity-transcript .entity-icon { background: linear-gradient(135deg, #f97316, #ea580c); }
    .entity-job .entity-icon { background: linear-gradient(135deg, #6366f1, #4f46e5); }
    .entity-item .entity-icon { background: linear-gradient(135deg, #ef4444, #dc2626); }
    .entity-audit .entity-icon { background: linear-gradient(135deg, #64748b, #475569); }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Entities & Relationships</h1>
    </div>

    <div class="diagram-wrapper" id="diagram">
      <svg class="connections" id="svg-connections"></svg>

      <div class="legend">
        <div class="legend-title">Legend</div>
        <div class="legend-item">
          <div class="legend-line"></div>
          <span>Foreign Key Relationship</span>
        </div>
        <div class="legend-item">
          <span style="color: #60a5fa;">1:N</span>
          <span>One-to-Many</span>
        </div>
        <div class="legend-item">
          <span style="color: #60a5fa;">1:1</span>
          <span>One-to-One</span>
        </div>
      </div>

      <!-- Row 1 -->
      <div class="entity entity-org" data-id="org" style="left: 50px; top: 50px;">
        <div class="entity-header">
          <div class="entity-icon">üè¢</div>
          <div class="entity-title">
            <div class="entity-name">ORGANIZATION</div>
            <div class="entity-type">tenant / workspace</div>
          </div>
        </div>
        <div class="entity-fields">
          <div class="entity-field">id (PK UUID)</div>
          <div class="entity-field">name</div>
          <div class="entity-field">created_at</div>
        </div>
        <div class="entity-reason">Separates tenants for scoping, quotas and access control.</div>
      </div>

      <div class="entity entity-user" data-id="user" style="left: 400px; top: 50px;">
        <div class="entity-header">
          <div class="entity-icon">üë§</div>
          <div class="entity-title">
            <div class="entity-name">USER</div>
            <div class="entity-type">global identity</div>
          </div>
        </div>
        <div class="entity-fields">
          <div class="entity-field">id (PK UUID)</div>
          <div class="entity-field">email</div>
          <div class="entity-field">name</div>
          <div class="entity-field">created_at</div>
        </div>
        <div class="entity-reason">Represents human users; keep global for multi-org membership.</div>
      </div>

      <div class="entity entity-audit" data-id="audit" style="left: 750px; top: 50px;">
        <div class="entity-header">
          <div class="entity-icon">üìã</div>
          <div class="entity-title">
            <div class="entity-name">AUDIT_LOG</div>
            <div class="entity-type">generic event store</div>
          </div>
        </div>
        <div class="entity-fields">
          <div class="entity-field">id</div>
          <div class="entity-field">organization_id (FK)</div>
          <div class="entity-field">event_type</div>
          <div class="entity-field">payload</div>
          <div class="entity-field">created_at</div>
        </div>
        <div class="entity-reason">Append-only logs for debugging + compliance.</div>
      </div>

      <!-- Row 2 -->
      <div class="entity entity-integration" data-id="integration" style="left: 50px; top: 300px;">
        <div class="entity-header">
          <div class="entity-icon">üîå</div>
          <div class="entity-title">
            <div class="entity-name">INTEGRATION</div>
            <div class="entity-type">provider instance</div>
          </div>
        </div>
        <div class="entity-fields">
          <div class="entity-field">id (PK UUID)</div>
          <div class="entity-field">organization_id (FK)</div>
          <div class="entity-field">provider_key</div>
          <div class="entity-field">config (JSONB)</div>
          <div class="entity-field">enabled</div>
        </div>
        <div class="entity-reason">Generic metadata for any external provider (Fathom, Linear, etc.).</div>
      </div>

      <div class="entity entity-user" data-id="user_integration" style="left: 400px; top: 300px;">
        <div class="entity-header">
          <div class="entity-icon">üîó</div>
          <div class="entity-title">
            <div class="entity-name">USER_INTEGRATION</div>
            <div class="entity-type">per-user account (optional)</div>
          </div>
        </div>
        <div class="entity-fields">
          <div class="entity-field">id</div>
          <div class="entity-field">user_id (FK)</div>
          <div class="entity-field">integration_id (FK)</div>
          <div class="entity-field">account_data (JSONB)</div>
        </div>
        <div class="entity-reason">Only if per-user provider scopes are needed.</div>
      </div>

      <!-- Row 3 -->
      <div class="entity entity-resource" data-id="external_resource" style="left: 50px; top: 550px;">
        <div class="entity-header">
          <div class="entity-icon">üìÅ</div>
          <div class="entity-title">
            <div class="entity-name">EXTERNAL_RESOURCE</div>
            <div class="entity-type">meeting / recording</div>
          </div>
        </div>
        <div class="entity-fields">
          <div class="entity-field">id</div>
          <div class="entity-field">integration_id (FK)</div>
          <div class="entity-field">external_id</div>
          <div class="entity-field">resource_type</div>
          <div class="entity-field">metadata (JSONB)</div>
        </div>
        <div class="entity-reason">Generic provider object; use UNIQUE(integration_id, external_id).</div>
      </div>

      <div class="entity entity-transcript" data-id="transcript" style="left: 400px; top: 550px;">
        <div class="entity-header">
          <div class="entity-icon">üìÑ</div>
          <div class="entity-title">
            <div class="entity-name">TRANSCRIPT</div>
            <div class="entity-type">raw import</div>
          </div>
        </div>
        <div class="entity-fields">
          <div class="entity-field">id</div>
          <div class="entity-field">external_resource_id (FK)</div>
          <div class="entity-field">raw_payload</div>
          <div class="entity-field">duration_ms</div>
          <div class="entity-field">language</div>
          <div class="entity-field">imported_at</div>
        </div>
        <div class="entity-reason">Stores original transcript payload; supports reprocessing.</div>
      </div>

      <div class="entity entity-transcript" data-id="transcript_segment" style="left: 750px; top: 550px;">
        <div class="entity-header">
          <div class="entity-icon">üîÄ</div>
          <div class="entity-title">
            <div class="entity-name">TRANSCRIPT_SEGMENT</div>
            <div class="entity-type">normalized segments (optional)</div>
          </div>
        </div>
        <div class="entity-fields">
          <div class="entity-field">id</div>
          <div class="entity-field">transcript_id (FK)</div>
          <div class="entity-field">start_ms</div>
          <div class="entity-field">end_ms</div>
          <div class="entity-field">speaker</div>
          <div class="entity-field">text</div>
        </div>
        <div class="entity-reason">Useful for FTS + timestamp navigation; optional.</div>
      </div>

      <!-- Row 4 -->
      <div class="entity entity-job" data-id="job" style="left: 400px; top: 800px;">
        <div class="entity-header">
          <div class="entity-icon">‚öôÔ∏è</div>
          <div class="entity-title">
            <div class="entity-name">JOB</div>
            <div class="entity-type">LLM / processing</div>
          </div>
        </div>
        <div class="entity-fields">
          <div class="entity-field">id</div>
          <div class="entity-field">transcript_id (FK)</div>
          <div class="entity-field">requested_by_user_id (FK)</div>
          <div class="entity-field">purpose</div>
          <div class="entity-field">input_snapshot</div>
          <div class="entity-field">output_snapshot</div>
          <div class="entity-field">status</div>
        </div>
        <div class="entity-reason">Captures LLM runs for reproducibility + debugging.</div>
      </div>

      <!-- Row 5 -->
      <div class="entity entity-item" data-id="item" style="left: 400px; top: 1050px;">
        <div class="entity-header">
          <div class="entity-icon">‚úÖ</div>
          <div class="entity-title">
            <div class="entity-name">ITEM</div>
            <div class="entity-type">action item / ticket</div>
          </div>
        </div>
        <div class="entity-fields">
          <div class="entity-field">id</div>
          <div class="entity-field">organization_id (FK)</div>
          <div class="entity-field">job_id (FK)</div>
          <div class="entity-field">transcript_id (FK)</div>
          <div class="entity-field">title</div>
          <div class="entity-field">description</div>
          <div class="entity-field">status</div>
          <div class="entity-field">confidence</div>
          <div class="entity-field">metadata</div>
        </div>
        <div class="entity-reason">Canonical representation of extracted actions/tickets.</div>
      </div>

      <div class="entity entity-user" data-id="item_assignment" style="left: 750px; top: 1050px;">
        <div class="entity-header">
          <div class="entity-icon">üë•</div>
          <div class="entity-title">
            <div class="entity-name">ITEM_ASSIGNMENT</div>
            <div class="entity-type">assignment history (optional)</div>
          </div>
        </div>
        <div class="entity-fields">
          <div class="entity-field">id</div>
          <div class="entity-field">item_id (FK)</div>
          <div class="entity-field">user_id (FK)</div>
          <div class="entity-field">assignee_email</div>
          <div class="entity-field">assigned_at</div>
          <div class="entity-field">active</div>
        </div>
        <div class="entity-reason">Keeps assignment history; omit if not needed.</div>
      </div>

      <div class="entity entity-integration" data-id="external_mapping" style="left: 50px; top: 1050px;">
        <div class="entity-header">
          <div class="entity-icon">üîó</div>
          <div class="entity-title">
            <div class="entity-name">EXTERNAL_MAPPING</div>
            <div class="entity-type">link to external ticket</div>
          </div>
        </div>
        <div class="entity-fields">
          <div class="entity-field">id</div>
          <div class="entity-field">item_id (FK)</div>
          <div class="entity-field">integration_id (FK)</div>
          <div class="entity-field">external_item_id</div>
          <div class="entity-field">request_payload</div>
          <div class="entity-field">response_payload</div>
        </div>
        <div class="entity-reason">Avoids duplicate pushes; stores remote mapping.</div>
      </div>

      <div class="entity entity-audit" data-id="push_event" style="left: 1100px; top: 1050px;">
        <div class="entity-header">
          <div class="entity-icon">üì§</div>
          <div class="entity-title">
            <div class="entity-name">PUSH_EVENT</div>
            <div class="entity-type">push audit</div>
          </div>
        </div>
        <div class="entity-fields">
          <div class="entity-field">id</div>
          <div class="entity-field">item_id (FK)</div>
          <div class="entity-field">integration_id (FK)</div>
          <div class="entity-field">status</div>
          <div class="entity-field">error_message</div>
          <div class="entity-field">request_payload</div>
          <div class="entity-field">response_payload</div>
        </div>
        <div class="entity-reason">Immutable log of push attempts.</div>
      </div>
    </div>
  </div>

  <script>
    // Define relationships with their cardinality
    const relationships = [
      { from: 'org', to: 'integration', label: '1:N' },
      { from: 'org', to: 'item', label: '1:N' },
      { from: 'org', to: 'audit', label: '1:N' },
      { from: 'user', to: 'user_integration', label: '1:N' },
      { from: 'user', to: 'job', label: '1:N' },
      { from: 'user', to: 'item_assignment', label: '1:N' },
      { from: 'integration', to: 'user_integration', label: '1:N' },
      { from: 'integration', to: 'external_resource', label: '1:N' },
      { from: 'integration', to: 'external_mapping', label: '1:N' },
      { from: 'integration', to: 'push_event', label: '1:N' },
      { from: 'external_resource', to: 'transcript', label: '1:1' },
      { from: 'transcript', to: 'transcript_segment', label: '1:N' },
      { from: 'transcript', to: 'job', label: '1:N' },
      { from: 'transcript', to: 'item', label: '1:N' },
      { from: 'job', to: 'item', label: '1:N' },
      { from: 'item', to: 'item_assignment', label: '1:N' },
      { from: 'item', to: 'external_mapping', label: '1:N' },
      { from: 'item', to: 'push_event', label: '1:N' }
    ];

    function getCenter(element) {
      const rect = element.getBoundingClientRect();
      const parent = document.getElementById('diagram').getBoundingClientRect();
      return {
        x: rect.left - parent.left + rect.width / 2,
        y: rect.top - parent.top + rect.height / 2
      };
    }

    function drawConnections() {
      const svg = document.getElementById('svg-connections');
      svg.innerHTML = '';

      relationships.forEach(rel => {
        const fromEl = document.querySelector(`[data-id="${rel.from}"]`);
        const toEl = document.querySelector(`[data-id="${rel.to}"]`);
        
        if (!fromEl || !toEl) return;

        const from = getCenter(fromEl);
        const to = getCenter(toEl);

        // Calculate control points for curved line
        const dx = to.x - from.x;
        const dy = to.y - from.y;
        const curve = Math.abs(dx) * 0.3;

        // Create curved path
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('class', 'connection-line');
        path.setAttribute('d', `M ${from.x} ${from.y} Q ${from.x + dx/2} ${from.y + dy/2 - curve} ${to.x} ${to.y}`);
        svg.appendChild(path);

        // Add label
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('class', 'connection-label');
        text.setAttribute('x', from.x + dx/2);
        text.setAttribute('y', from.y + dy/2 - curve - 5);
        text.textContent = rel.label;
        svg.appendChild(text);
      });
    }

    // Drag and drop functionality
    let draggedElement = null;
    let offsetX = 0;
    let offsetY = 0;

    document.querySelectorAll('.entity').forEach(entity => {
      entity.addEventListener('mousedown', (e) => {
        draggedElement = entity;
        const rect = entity.getBoundingClientRect();
        const parent = document.getElementById('diagram').getBoundingClientRect();
        offsetX = e.clientX - rect.left;
        offsetY = e.clientY - rect.top;
        entity.style.cursor = 'grabbing';
        entity.style.zIndex = '1000';
      });
    });

    document.addEventListener('mousemove', (e) => {
      if (draggedElement) {
        e.preventDefault();
        const parent = document.getElementById('diagram').getBoundingClientRect();
        let newX = e.clientX - parent.left - offsetX;
        let newY = e.clientY - parent.top - offsetY;

        // Keep within bounds
        newX = Math.max(0, Math.min(newX, parent.width - draggedElement.offsetWidth));
        newY = Math.max(0, Math.min(newY, parent.height - draggedElement.offsetHeight));

        draggedElement.style.left = newX + 'px';
        draggedElement.style.top = newY + 'px';

        // Redraw connections while dragging
        drawConnections();
      }
    });

    document.addEventListener('mouseup', () => {
      if (draggedElement) {
        draggedElement.style.cursor = 'pointer';
        draggedElement.style.zIndex = '2';
        draggedElement = null;
      }
    });

    // Draw connections on load and resize
    window.addEventListener('load', drawConnections);
    window.addEventListener('resize', drawConnections);
  </script>
</body>
</html>
